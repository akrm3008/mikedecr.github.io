<!DOCTYPE html>
<html lang="en-us">
  <head>

  

  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="Michael DeCrescenzo">
  <meta name="description" content="Ph.D. Candidate, Political Science, University of Wisconsin–Madison">
  <meta name="keywords" content="political science, university of wisconsin madison, uw madison">
  
  <link rel="prev" href="/2018/2018-10-19-partialling-out/" />
  
  <link rel="canonical" href="/2018/2018-11-29-hava-xl/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/site/apple-touch-icon.png">
  <link rel="icon" href="/images/site/favicon-area-chart.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="/images/site/favicon-area-chart.ico" type="image/x-icon">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Using the Tidyverse with Voter Registration Linkage Data | Michael DeCrescenzo
       
  </title>
  <meta name="title" content="Using the Tidyverse with Voter Registration Linkage Data | Michael DeCrescenzo">
    

  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "/"
    },
    "articleSection" : "posts",
    "name" : "Using the Tidyverse with Voter Registration Linkage Data",
    "headline" : "Using the Tidyverse with Voter Registration Linkage Data",
    "description" : "Working with SSA data the tidy way",
    "inLanguage" : "en-us",
    "author" : "Mike DeCrescenzo",
    "creator" : "Mike DeCrescenzo",
    "publisher": "Mike DeCrescenzo",
    "accountablePerson" : "Mike DeCrescenzo",
    "copyrightHolder" : "Mike DeCrescenzo",
    "copyrightYear" : "2018",
    "datePublished": "2018-11-29 00:00:00 &#43;0000 UTC",
    "dateModified" : "2018-11-29 00:00:00 &#43;0000 UTC",
    "url" : "/2018/2018-11-29-hava-xl/",
    "wordCount" : "4284",
    "keywords" : [ "data","tidyverse","R&#34;", "Michael DeCrescenzo"]
}
</script>

  <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });

  MathJax.Hub.Config({
  
  TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
</script>
  
<script type="text/javascript">
var sc_project=11382424; 
var sc_invisible=1; 
var sc_security="647b3843"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="Web Analytics
Made Easy - StatCounter" href="http://statcounter.com/"
target="_blank"><img class="statcounter"
src="//c.statcounter.com/11382424/0/647b3843/1/" alt="Web
Analytics Made Easy - StatCounter"></a></div></noscript>


</head>

  


  <body class="">
    <div class="wrapper">
        

<nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
         <a href="/">Home</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a class="menu-item" href="/research/" title="">Research</a>
                
                <a class="menu-item" href="/teaching/" title="">Teaching</a>
                
                <a class="menu-item" href="/code/" title="">Code</a>
                
                <a class="menu-item" href="/contact/" title="">Contact</a>
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="/">Michael DeCrescenzo</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a class="menu-item" href="/research/" title="">Research</a>
                
                <a class="menu-item" href="/teaching/" title="">Teaching</a>
                
                <a class="menu-item" href="/code/" title="">Code</a>
                
                <a class="menu-item" href="/contact/" title="">Contact</a>
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
        </div>
    </div>
</nav>


    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Using the Tidyverse with Voter Registration Linkage Data</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="/" rel="author">Mike DeCrescenzo</a>
                <span class="post-time">
                on <time datetime=2018-11-29 itemprop="datePublished">November 29, 2018</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="/categories/methods/"> Methods </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
</style>


<p>This blog post demonstrates how you can use R and the Tidyverse tools to make quick work of some voter registration data. The post highlights:</p>
<ul>
<li>How to read many an Excel file with multiple sheets using <code>{readxl}</code>.</li>
<li>Organizing data efficiently with list columns using tibbles</li>
<li>Cleaning many data tables simultaneously using <code>{purrr}</code></li>
</ul>
<div id="the-data" class="section level1">
<h1>The data</h1>
<p>The Help America Vote Act, passed in the wake of the 2000 presidential elections, requires states to verify information from voter registration applications. Voters may include their driver’s license numbers on their applications—which states are responsible for verifying—or they may include the last four digits of their Social Security number. Social Security information is validated against the Social Security Administration’s databases.</p>
<p>But the data are messy, as are the data for any record-linkage endeavor. We have names, birth dates, and only 4 digits of a social security number (which aren’t uniquely always identifying). Voters may mistype these fields into a web page, or state workers may mistype them. There may be last-name changes that create issues. Computers may do a bad job parsing the punctuation and spacing in someone’s last name.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> As a result, voter registration applications may not match any SSA records, or they do not match to one unique SSA record. There are indeed enough people in the U.S., and enough noise in the way SSA numbers are assigned, that there can be multiple cases with the same last name, birthday, and last 4 digits of one’s SS number.</p>
<p>The data we’ll use is the SSA’s <a href="https://www.ssa.gov/open/havv/">summary tables</a> for these match attempts, which can be <a href="https://www.ssa.gov/open/havv/havv-jan2011-todate.html">browsed online or downloaded as a multi-sheet <code>.xlsx</code> file</a>. The file contains separate sheets for various dates at which new summaries were generated. We would like to shape the data into one single table, organized along a <code>date</code> variable.</p>
</div>
<div id="get-the-data-into-r" class="section level1">
<h1>Get the data into R</h1>
<p>First, we will load some packages: <code>here</code> manages relative directories, <code>tidyverse</code> contains a suite of helpful data manipulation tools, and <code>magrittr</code> contains some additional “pipes” that we will use. We will use functions from <code>readxl</code> and <code>lubridate</code> packages, but we will leave those unattached so they are easier to spot as we go.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;here&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;magrittr&quot;</span>)
<span class="co"># don&#39;t attach: readxl, lubridate</span></code></pre>
<p>The primary issue with reading the data is that there are multiple sheets in the same Excel file. We want to determine the names of each sheet and then use those names to read the sheets separately. We can get the sheet names with <code>readxl::excel_sheets()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># path to data</span>
data_dir &lt;-<span class="st"> &quot;static/data&quot;</span>

<span class="co"># sheets are named. Let&#39;s get them.</span>
<span class="co"># pass the file name to readxl::excel_sheets()</span>
sheet_names &lt;-<span class="st"> </span>readxl<span class="op">::</span><span class="kw">excel_sheets</span>(<span class="kw">here</span>(data_dir, <span class="st">&quot;HAVV-running-list.xlsx&quot;</span>))

<span class="co"># look at some names</span>
<span class="kw">head</span>(sheet_names, <span class="dt">n =</span> <span class="dv">10</span>)
<span class="co">##  [1] &quot;January 2011-to date&quot; &quot;111018&quot;               &quot;110318&quot;              </span>
<span class="co">##  [4] &quot;102718&quot;               &quot;102018&quot;               &quot;101318&quot;              </span>
<span class="co">##  [7] &quot;100618&quot;               &quot;092918&quot;               &quot;092218&quot;              </span>
<span class="co">## [10] &quot;091518&quot;</span></code></pre>
<p>Right away, we noticed that some of the sheets are dated using a <code>mmddyy</code> format, while others are summaries of the data. We will want to clean those summaries out—we can re-calculate them ourselves more reliably (read: without Excel formulas).</p>
<div id="sheets-as-list-elements" class="section level2">
<h2>Sheets as list elements</h2>
<p>One thing we could do is read the data as a list of data frames, one list element for each sheet. We can do this with <code>lapply()</code> and an anonymous function.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># lapply() approach</span>
<span class="co"># I never know the best way to indent with an anonymous function</span>
havv_list &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">lapply</span>(sheet_names, <span class="cf">function</span>(x)
    readxl<span class="op">::</span><span class="kw">read_excel</span>(<span class="kw">here</span>(data_dir, <span class="st">&quot;HAVV-running-list.xlsx&quot;</span>), <span class="dt">sheet =</span> x)
  )
<span class="co">## The `validate` argument to `as_tibble()` is deprecated. Please use `.name_repair` to control column names.</span>

<span class="co"># name the list elements</span>
<span class="kw">names</span>(havv_list) &lt;-<span class="st"> </span>sheet_names</code></pre>
<p>There are over 400 data frames inside of <code>havv-list</code>. Let’s look at some.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(havv_list, <span class="dt">n =</span> <span class="dv">2</span>)
<span class="co">## $`January 2011-to date`</span>
<span class="co">## # A tibble: 56 x 10</span>
<span class="co">##    `STATE/TERRITORY` X__1   X__2  `(Z)` X__3  `(X)` `(Y)` `(V)` `(T)` `(W)`</span>
<span class="co">##    &lt;chr&gt;             &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">##  1 &lt;NA&gt;              &lt;NA&gt;   UN    TOTAL &lt;NA&gt;  SING… SING… MULT… MULT… MULT…</span>
<span class="co">##  2 &lt;NA&gt;              TOTAL  PROC… NON   TOTAL MATCH MATCH MATCH MATCH MATCH</span>
<span class="co">##  3 &lt;NA&gt;              TRANS… TRAN… MATC… MATC… ALIVE DECE… ALIVE DECE… MIXED</span>
<span class="co">##  4 ----------------… -----… ----… ----… ----… ----… ----… ----… ----… ----…</span>
<span class="co">##  5 Alabama           11858… 40    1569… 1028… 9717… 56916 209   1     38   </span>
<span class="co">##  6 Alaska            26424  0     8725  17699 16171 1526  1     0     1    </span>
<span class="co">##  7 Arizona           24236… 133   9605… 1462… 1452… 9829  253   0     5    </span>
<span class="co">##  8 Arkansas          94537  0     32859 61678 61553 103   19    0     3    </span>
<span class="co">##  9 California        65935… 36    5654… 9388… 9325… 6129  133   0     16   </span>
<span class="co">## 10 Colorado          458296 0     1840… 2742… 2731… 1072  34    0     4    </span>
<span class="co">## # … with 46 more rows</span>
<span class="co">## </span>
<span class="co">## $`111018`</span>
<span class="co">## # A tibble: 56 x 10</span>
<span class="co">##    `STATE/TERRITORY` X__1   X__2  `(Z)` X__3  `(X)` `(Y)` `(V)` `(T)` `(W)`</span>
<span class="co">##    &lt;chr&gt;             &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">##  1 &lt;NA&gt;              &lt;NA&gt;   UN    TOTAL &lt;NA&gt;  SING… SING… MULT… MULT… MULT…</span>
<span class="co">##  2 &lt;NA&gt;              TOTAL  PROC… NON   TOTAL MATCH MATCH MATCH MATCH MATCH</span>
<span class="co">##  3 &lt;NA&gt;              TRANS… TRAN… MATC… MATC… ALIVE DECE… ALIVE DECE… MIXED</span>
<span class="co">##  4 ----------------… -----… ----… ----… ----… ----… ----… ----… ----… ----…</span>
<span class="co">##  5 ALABAMA           1069   0     147   922   885   37    0     0     0    </span>
<span class="co">##  6 ALASKA            34     0     11    23    21    2     0     0     0    </span>
<span class="co">##  7 ARIZONA           753    0     202   551   551   0     0     0     0    </span>
<span class="co">##  8 ARKANSAS          0      0     0     0     0     0     0     0     0    </span>
<span class="co">##  9 CALIFORNIA        47923  0     25583 22340 22310 28    2     0     0    </span>
<span class="co">## 10 COLORADO          0      0     0     0     0     0     0     0     0    </span>
<span class="co">## # … with 46 more rows</span></code></pre>
<p>Great, so the variable names in the original spread sheet are an absolute mess. Not only are they spread across multiple rows, they’ve converted all of the data to character strings instead of numbers.</p>
<p>To fix the variable names, we will want to know what these names <em>should</em> be. Let’s get a look by printing the first three rows of each column.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># take first data frame %&gt;%</span>
<span class="co">#   for each column, show the first 3 elements</span>
havv_list[[<span class="dv">1</span>]] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">lapply</span>(<span class="cf">function</span>(x) x[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])
<span class="co">## $`STATE/TERRITORY`</span>
<span class="co">## [1] NA NA NA</span>
<span class="co">## </span>
<span class="co">## $X__1</span>
<span class="co">## [1] NA             &quot;TOTAL&quot;        &quot;TRANSACTIONS&quot;</span>
<span class="co">## </span>
<span class="co">## $X__2</span>
<span class="co">## [1] &quot;UN&quot;           &quot;PROCESSED&quot;    &quot;TRANSACTIONS&quot;</span>
<span class="co">## </span>
<span class="co">## $`(Z)`</span>
<span class="co">## [1] &quot;TOTAL&quot;   &quot;NON&quot;     &quot;MATCHES&quot;</span>
<span class="co">## </span>
<span class="co">## $X__3</span>
<span class="co">## [1] NA        &quot;TOTAL&quot;   &quot;MATCHES&quot;</span>
<span class="co">## </span>
<span class="co">## $`(X)`</span>
<span class="co">## [1] &quot;SINGLE&quot; &quot;MATCH&quot;  &quot;ALIVE&quot; </span>
<span class="co">## </span>
<span class="co">## $`(Y)`</span>
<span class="co">## [1] &quot;SINGLE&quot;   &quot;MATCH&quot;    &quot;DECEASED&quot;</span>
<span class="co">## </span>
<span class="co">## $`(V)`</span>
<span class="co">## [1] &quot;MULTIPLE&quot; &quot;MATCH&quot;    &quot;ALIVE&quot;   </span>
<span class="co">## </span>
<span class="co">## $`(T)`</span>
<span class="co">## [1] &quot;MULTIPLE&quot; &quot;MATCH&quot;    &quot;DECEASED&quot;</span>
<span class="co">## </span>
<span class="co">## $`(W)`</span>
<span class="co">## [1] &quot;MULTIPLE&quot; &quot;MATCH&quot;    &quot;MIXED&quot;</span></code></pre>
<p>So we have state, total transactions, unprocessed transactions, and so on. We store these in a vector for later.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># store a revised names as a vector</span>
varnames &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;state&quot;</span>, 
              <span class="st">&quot;total_transactions&quot;</span>, <span class="st">&quot;unprocessed_transactions&quot;</span>, 
              <span class="st">&quot;total_nonmatches&quot;</span>, <span class="st">&quot;total_matches&quot;</span>, 
              <span class="st">&quot;single_match_alive&quot;</span>, <span class="st">&quot;single_match_deceased&quot;</span>,
              <span class="st">&quot;multi_match_alive&quot;</span>, <span class="st">&quot;multi_match_deceased&quot;</span>, <span class="st">&quot;multi_match_mixed&quot;</span>)</code></pre>
<p>We want to double check that these are the same variables we have in every table. One way to start looking at that is by viewing the number of columns in each table.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># How many columns per table? Express as a vector</span>
<span class="co"># then tabulate the number of columns</span>
<span class="kw">sapply</span>(havv_list, ncol) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">table</span>()
<span class="co">## .</span>
<span class="co">##    10 16138 </span>
<span class="co">##   406     6</span></code></pre>
<p>Okay…so most tables have 10 columns, but some inexplicably have 16,138 columns. At this point, I’m thinking I want to do things to the data such as, “Give me only the tables that have more than 10 columns” so I can manipulate those as a separate object. However, the list-of-data-frames isn’t the most amenable to these types of manipulations. Instead, we will use <code>purrr</code> tools to hold the data frames as a list-column within another data frame. I know, wild.</p>
</div>
<div id="purrr-approach-sheets-as-list-column" class="section level2">
<h2>Purrr approach: sheets as list-column</h2>
<p>Imagine you had a data frame, but one of the variables didn’t contain just one value per cell, but instead contained a dataset per cell. That’s what we will do.</p>
<p>We start by creating a data frame that has the sheet names as a variable. We will then use <code>purrr::map</code> to loop over those sheet names and place each data table into its corresponding cell. Like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># start with sheet names in a data frame</span>
havv_df &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">sheet_name =</span> sheet_names) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">print</span>()
<span class="co">## # A tibble: 412 x 1</span>
<span class="co">##    sheet_name          </span>
<span class="co">##    &lt;chr&gt;               </span>
<span class="co">##  1 January 2011-to date</span>
<span class="co">##  2 111018              </span>
<span class="co">##  3 110318              </span>
<span class="co">##  4 102718              </span>
<span class="co">##  5 102018              </span>
<span class="co">##  6 101318              </span>
<span class="co">##  7 100618              </span>
<span class="co">##  8 092918              </span>
<span class="co">##  9 092218              </span>
<span class="co">## 10 091518              </span>
<span class="co">## # … with 402 more rows</span>

<span class="co"># purrr::map(): for each name, read sheet from file</span>
havv_df &lt;-<span class="st"> </span>havv_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">data =</span> <span class="kw">map</span>(sheet_name, 
               <span class="op">~</span><span class="st"> </span>readxl<span class="op">::</span><span class="kw">read_excel</span>(<span class="kw">here</span>(data_dir, <span class="st">&quot;HAVV-running-list.xlsx&quot;</span>),
                                    <span class="dt">sheet =</span> .x))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">print</span>()
<span class="co">## # A tibble: 412 x 2</span>
<span class="co">##    sheet_name           data              </span>
<span class="co">##    &lt;chr&gt;                &lt;list&gt;            </span>
<span class="co">##  1 January 2011-to date &lt;tibble [56 × 10]&gt;</span>
<span class="co">##  2 111018               &lt;tibble [56 × 10]&gt;</span>
<span class="co">##  3 110318               &lt;tibble [56 × 10]&gt;</span>
<span class="co">##  4 102718               &lt;tibble [56 × 10]&gt;</span>
<span class="co">##  5 102018               &lt;tibble [56 × 10]&gt;</span>
<span class="co">##  6 101318               &lt;tibble [56 × 10]&gt;</span>
<span class="co">##  7 100618               &lt;tibble [56 × 10]&gt;</span>
<span class="co">##  8 092918               &lt;tibble [56 × 10]&gt;</span>
<span class="co">##  9 092218               &lt;tibble [56 × 10]&gt;</span>
<span class="co">## 10 091518               &lt;tibble [56 × 10]&gt;</span>
<span class="co">## # … with 402 more rows</span></code></pre>
</div>
</div>
<div id="cleaning-the-data-with-purrr" class="section level1">
<h1>Cleaning the data with <code>purrr</code></h1>
<div id="rows-and-columns" class="section level2">
<h2>Rows and columns</h2>
<p>Let’s grab one of those tables that had 16 thousand columns. Start by creating a column in the data that stores the number of columns for each table, and then we’ll examine one of the abnormal tables. Do this by applying <code>ncol()</code> to every table using <code>map_int()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># grab a table with more than 10 variables and look at it</span>
bad_table &lt;-<span class="st"> </span>havv_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ncol =</span> <span class="kw">map_int</span>(data, ncol)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(ncol <span class="op">!=</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">print</span>()
<span class="co">## # A tibble: 56 x 16,140</span>
<span class="co">##    sheet_name  ncol `STATE/TERRITOR… X__1  X__2  `(Z)` X__3  `(X)` `(Y)`</span>
<span class="co">##    &lt;chr&gt;      &lt;int&gt; &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">##  1 083113     16138 &lt;NA&gt;             &lt;NA&gt;  UN    TOTAL &lt;NA&gt;  SING… SING…</span>
<span class="co">##  2 083113     16138 &lt;NA&gt;             TOTAL PROC… NON   TOTAL MATCH MATCH</span>
<span class="co">##  3 083113     16138 &lt;NA&gt;             TRAN… TRAN… MATC… MATC… ALIVE DECE…</span>
<span class="co">##  4 083113     16138 ---------------… ----… ----… ----… ----… ----… ----…</span>
<span class="co">##  5 083113     16138 Alabama          4010  0     463   3547  3436  110  </span>
<span class="co">##  6 083113     16138 Alaska           29    0     10    19    19    0    </span>
<span class="co">##  7 083113     16138 Arizona          304   0     140   164   160   4    </span>
<span class="co">##  8 083113     16138 Arkansas         394   0     113   281   279   2    </span>
<span class="co">##  9 083113     16138 California       22781 0     22001 780   769   11   </span>
<span class="co">## 10 083113     16138 Colorado         0     0     0     0     0     0    </span>
<span class="co">## # … with 46 more rows, and 16,131 more variables: `(V)` &lt;chr&gt;,</span>
<span class="co">## #   `(T)` &lt;chr&gt;, `(W)` &lt;chr&gt;, X__4 &lt;lgl&gt;, X__5 &lt;lgl&gt;, X__6 &lt;lgl&gt;,</span>
<span class="co">## #   X__7 &lt;lgl&gt;, X__8 &lt;lgl&gt;, X__9 &lt;lgl&gt;, X__10 &lt;lgl&gt;, X__11 &lt;lgl&gt;,</span>
<span class="co">## #   X__12 &lt;lgl&gt;, X__13 &lt;lgl&gt;, X__14 &lt;lgl&gt;, X__15 &lt;lgl&gt;, X__16 &lt;lgl&gt;,</span>
<span class="co">## #   X__17 &lt;lgl&gt;, X__18 &lt;lgl&gt;, X__19 &lt;lgl&gt;, X__20 &lt;lgl&gt;, X__21 &lt;lgl&gt;,</span>
<span class="co">## #   X__22 &lt;lgl&gt;, X__23 &lt;lgl&gt;, X__24 &lt;lgl&gt;, X__25 &lt;lgl&gt;, X__26 &lt;lgl&gt;,</span>
<span class="co">## #   X__27 &lt;lgl&gt;, X__28 &lt;lgl&gt;, X__29 &lt;lgl&gt;, X__30 &lt;lgl&gt;, X__31 &lt;lgl&gt;,</span>
<span class="co">## #   X__32 &lt;lgl&gt;, X__33 &lt;lgl&gt;, X__34 &lt;lgl&gt;, X__35 &lt;lgl&gt;, X__36 &lt;lgl&gt;,</span>
<span class="co">## #   X__37 &lt;lgl&gt;, X__38 &lt;lgl&gt;, X__39 &lt;lgl&gt;, X__40 &lt;lgl&gt;, X__41 &lt;lgl&gt;,</span>
<span class="co">## #   X__42 &lt;lgl&gt;, X__43 &lt;lgl&gt;, X__44 &lt;lgl&gt;, X__45 &lt;lgl&gt;, X__46 &lt;lgl&gt;,</span>
<span class="co">## #   X__47 &lt;lgl&gt;, X__48 &lt;lgl&gt;, X__49 &lt;lgl&gt;, X__50 &lt;lgl&gt;, X__51 &lt;lgl&gt;,</span>
<span class="co">## #   X__52 &lt;lgl&gt;, X__53 &lt;lgl&gt;, X__54 &lt;lgl&gt;, X__55 &lt;lgl&gt;, X__56 &lt;lgl&gt;,</span>
<span class="co">## #   X__57 &lt;lgl&gt;, X__58 &lt;lgl&gt;, X__59 &lt;lgl&gt;, X__60 &lt;lgl&gt;, X__61 &lt;lgl&gt;,</span>
<span class="co">## #   X__62 &lt;lgl&gt;, X__63 &lt;lgl&gt;, X__64 &lt;lgl&gt;, X__65 &lt;lgl&gt;, X__66 &lt;lgl&gt;,</span>
<span class="co">## #   X__67 &lt;lgl&gt;, X__68 &lt;lgl&gt;, X__69 &lt;lgl&gt;, X__70 &lt;lgl&gt;, X__71 &lt;lgl&gt;,</span>
<span class="co">## #   X__72 &lt;lgl&gt;, X__73 &lt;lgl&gt;, X__74 &lt;lgl&gt;, X__75 &lt;lgl&gt;, X__76 &lt;lgl&gt;,</span>
<span class="co">## #   X__77 &lt;lgl&gt;, X__78 &lt;lgl&gt;, X__79 &lt;lgl&gt;, X__80 &lt;lgl&gt;, X__81 &lt;lgl&gt;,</span>
<span class="co">## #   X__82 &lt;lgl&gt;, X__83 &lt;lgl&gt;, X__84 &lt;lgl&gt;, X__85 &lt;lgl&gt;, X__86 &lt;lgl&gt;,</span>
<span class="co">## #   X__87 &lt;lgl&gt;, X__88 &lt;lgl&gt;, X__89 &lt;lgl&gt;, X__90 &lt;lgl&gt;, X__91 &lt;lgl&gt;,</span>
<span class="co">## #   X__92 &lt;lgl&gt;, X__93 &lt;lgl&gt;, X__94 &lt;lgl&gt;, X__95 &lt;lgl&gt;, X__96 &lt;lgl&gt;,</span>
<span class="co">## #   X__97 &lt;lgl&gt;, X__98 &lt;lgl&gt;, X__99 &lt;lgl&gt;, X__100 &lt;lgl&gt;, …</span></code></pre>
<p>Luckily, these extra columns appear to be empty:</p>
<pre class="sourceCode r"><code class="sourceCode r">bad_table <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(X__<span class="dv">4</span><span class="op">:</span>X__<span class="dv">10</span>)
<span class="co">## # A tibble: 56 x 7</span>
<span class="co">##    X__4  X__5  X__6  X__7  X__8  X__9  X__10</span>
<span class="co">##    &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt;</span>
<span class="co">##  1 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">##  2 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">##  3 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">##  4 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">##  5 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">##  6 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">##  7 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">##  8 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">##  9 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">## 10 NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">## # … with 46 more rows</span></code></pre>
<p>If these columns are blank, we can apply a function over all of the datasets to keep only the rows and columns we want: we want to delete the first few rows (which contain ugly variable names) and only the first ten columns. We will use this chance to rename those variables according to the vector of names we saved above.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># map: for each dataset, </span>
<span class="co">#   drop the first 4 rows, keep only cols 1:10</span>
<span class="co">#   rename variables</span>
havv_df &lt;-<span class="st"> </span>havv_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, 
                    <span class="op">~</span><span class="st"> </span>.x[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) , <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>] <span class="op">%&gt;%</span>
<span class="st">                      </span><span class="kw">set_names</span>(varnames))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">print</span>()
<span class="co">## # A tibble: 412 x 2</span>
<span class="co">##    sheet_name           data              </span>
<span class="co">##    &lt;chr&gt;                &lt;list&gt;            </span>
<span class="co">##  1 January 2011-to date &lt;tibble [52 × 10]&gt;</span>
<span class="co">##  2 111018               &lt;tibble [52 × 10]&gt;</span>
<span class="co">##  3 110318               &lt;tibble [52 × 10]&gt;</span>
<span class="co">##  4 102718               &lt;tibble [52 × 10]&gt;</span>
<span class="co">##  5 102018               &lt;tibble [52 × 10]&gt;</span>
<span class="co">##  6 101318               &lt;tibble [52 × 10]&gt;</span>
<span class="co">##  7 100618               &lt;tibble [52 × 10]&gt;</span>
<span class="co">##  8 092918               &lt;tibble [52 × 10]&gt;</span>
<span class="co">##  9 092218               &lt;tibble [52 × 10]&gt;</span>
<span class="co">## 10 091518               &lt;tibble [52 × 10]&gt;</span>
<span class="co">## # … with 402 more rows</span>

<span class="co"># confirm that every table is 10 columns and 52 rows</span>
havv_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cols =</span> <span class="kw">map_int</span>(data, ncol),
         <span class="dt">rows =</span> <span class="kw">map_int</span>(data, nrow)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">count</span>(cols, rows)
<span class="co">## # A tibble: 1 x 3</span>
<span class="co">##    cols  rows     n</span>
<span class="co">##   &lt;int&gt; &lt;int&gt; &lt;int&gt;</span>
<span class="co">## 1    10    52   412</span>

<span class="co"># do things look good</span>
havv_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>()
<span class="co">## # A tibble: 52 x 11</span>
<span class="co">##    sheet_name state total_transacti… unprocessed_tra… total_nonmatches</span>
<span class="co">##    &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt;           </span>
<span class="co">##  1 052116     Alab… 837              0                116             </span>
<span class="co">##  2 052116     Alas… 35               0                3               </span>
<span class="co">##  3 052116     Ariz… 3210             0                914             </span>
<span class="co">##  4 052116     Arka… 183              0                53              </span>
<span class="co">##  5 052116     Cali… 14072            0                5921            </span>
<span class="co">##  6 052116     Colo… 0                0                0               </span>
<span class="co">##  7 052116     Conn… 275              0                53              </span>
<span class="co">##  8 052116     Dela… 0                0                0               </span>
<span class="co">##  9 052116     Dist… 0                0                0               </span>
<span class="co">## 10 052116     Flor… 1318             0                544             </span>
<span class="co">## # … with 42 more rows, and 6 more variables: total_matches &lt;chr&gt;,</span>
<span class="co">## #   single_match_alive &lt;chr&gt;, single_match_deceased &lt;chr&gt;,</span>
<span class="co">## #   multi_match_alive &lt;chr&gt;, multi_match_deceased &lt;chr&gt;,</span>
<span class="co">## #   multi_match_mixed &lt;chr&gt;</span></code></pre>
</div>
<div id="dating-each-sheet" class="section level2">
<h2>Dating each sheet</h2>
<p>At this point, we want to consider unnesting the data frames. We want to do this by “dating” each data frame with information contained in the sheet name. First, what are the sheet names?</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(havv_list)
<span class="co">##   [1] &quot;January 2011-to date&quot; &quot;111018&quot;               &quot;110318&quot;              </span>
<span class="co">##   [4] &quot;102718&quot;               &quot;102018&quot;               &quot;101318&quot;              </span>
<span class="co">##   [7] &quot;100618&quot;               &quot;092918&quot;               &quot;092218&quot;              </span>
<span class="co">##  [10] &quot;091518&quot;               &quot;090818&quot;               &quot;090118&quot;              </span>
<span class="co">##  [13] &quot;082518&quot;               &quot;081818&quot;               &quot;081118&quot;              </span>
<span class="co">##  [16] &quot;080418&quot;               &quot;072818&quot;               &quot;072118&quot;              </span>
<span class="co">##  [19] &quot;071418&quot;               &quot;070718&quot;               &quot;063018&quot;              </span>
<span class="co">##  [22] &quot;062318&quot;               &quot;061618&quot;               &quot;060918&quot;              </span>
<span class="co">##  [25] &quot;060218&quot;               &quot;052618&quot;               &quot;051918&quot;              </span>
<span class="co">##  [28] &quot;051218&quot;               &quot;050518&quot;               &quot;042818&quot;              </span>
<span class="co">##  [31] &quot;042118&quot;               &quot;041418&quot;               &quot;040718&quot;              </span>
<span class="co">##  [34] &quot;033118&quot;               &quot;032418&quot;               &quot;031718&quot;              </span>
<span class="co">##  [37] &quot;031018&quot;               &quot;030318&quot;               &quot;022418&quot;              </span>
<span class="co">##  [40] &quot;021718&quot;               &quot;021018&quot;               &quot;020318&quot;              </span>
<span class="co">##  [43] &quot;012718&quot;               &quot;012018&quot;               &quot;011318&quot;              </span>
<span class="co">##  [46] &quot;010618&quot;               &quot;123017&quot;               &quot;122317&quot;              </span>
<span class="co">##  [49] &quot;121617&quot;               &quot;120917&quot;               &quot;120217&quot;              </span>
<span class="co">##  [52] &quot;112517&quot;               &quot;111817&quot;               &quot;111117&quot;              </span>
<span class="co">##  [55] &quot;110417&quot;               &quot;102817&quot;               &quot;102117&quot;              </span>
<span class="co">##  [58] &quot;101417&quot;               &quot;100717&quot;               &quot;093017&quot;              </span>
<span class="co">##  [61] &quot;092317&quot;               &quot;091617&quot;               &quot;09092017&quot;            </span>
<span class="co">##  [64] &quot;090217&quot;               &quot;082617&quot;               &quot;081917&quot;              </span>
<span class="co">##  [67] &quot;081217&quot;               &quot;080517&quot;               &quot;072917&quot;              </span>
<span class="co">##  [70] &quot;072217&quot;               &quot;071517&quot;               &quot;070817&quot;              </span>
<span class="co">##  [73] &quot;070117&quot;               &quot;062417&quot;               &quot;061717&quot;              </span>
<span class="co">##  [76] &quot;061017&quot;               &quot;060317&quot;               &quot;052717&quot;              </span>
<span class="co">##  [79] &quot;052017&quot;               &quot;051317&quot;               &quot;050617&quot;              </span>
<span class="co">##  [82] &quot;042917&quot;               &quot;042217&quot;               &quot;041517&quot;              </span>
<span class="co">##  [85] &quot;040817&quot;               &quot;040117&quot;               &quot;032517&quot;              </span>
<span class="co">##  [88] &quot;031817&quot;               &quot;031117&quot;               &quot;030417&quot;              </span>
<span class="co">##  [91] &quot;022517&quot;               &quot;021817&quot;               &quot;021117&quot;              </span>
<span class="co">##  [94] &quot;020417&quot;               &quot;012817&quot;               &quot;012117&quot;              </span>
<span class="co">##  [97] &quot;011417&quot;               &quot;010717&quot;               &quot;123116&quot;              </span>
<span class="co">## [100] &quot;122416&quot;               &quot;121716&quot;               &quot;121016&quot;              </span>
<span class="co">## [103] &quot;120316&quot;               &quot;112616&quot;               &quot;111916&quot;              </span>
<span class="co">## [106] &quot;111216&quot;               &quot;110516&quot;               &quot;102916&quot;              </span>
<span class="co">## [109] &quot;102216&quot;               &quot;101516&quot;               &quot;100816&quot;              </span>
<span class="co">## [112] &quot;100116&quot;               &quot;092416&quot;               &quot;091716&quot;              </span>
<span class="co">## [115] &quot;091016&quot;               &quot;090316&quot;               &quot;082716&quot;              </span>
<span class="co">## [118] &quot;082016&quot;               &quot;081316&quot;               &quot;080616&quot;              </span>
<span class="co">## [121] &quot;073016&quot;               &quot;072316&quot;               &quot;071616&quot;              </span>
<span class="co">## [124] &quot;070916&quot;               &quot;070216&quot;               &quot;062516&quot;              </span>
<span class="co">## [127] &quot;061816&quot;               &quot;061116&quot;               &quot;060416&quot;              </span>
<span class="co">## [130] &quot;052816&quot;               &quot;052116&quot;               &quot;051416&quot;              </span>
<span class="co">## [133] &quot;050716&quot;               &quot;043016&quot;               &quot;042316&quot;              </span>
<span class="co">## [136] &quot;041616&quot;               &quot;040916&quot;               &quot;040216&quot;              </span>
<span class="co">## [139] &quot;032616&quot;               &quot;031916&quot;               &quot;031216&quot;              </span>
<span class="co">## [142] &quot;030516&quot;               &quot;022716&quot;               &quot;022016&quot;              </span>
<span class="co">## [145] &quot;021316&quot;               &quot;020616&quot;               &quot;013016&quot;              </span>
<span class="co">## [148] &quot;012316&quot;               &quot;011616&quot;               &quot;010916&quot;              </span>
<span class="co">## [151] &quot;010216&quot;               &quot;122615&quot;               &quot;121915&quot;              </span>
<span class="co">## [154] &quot;121215&quot;               &quot;120515&quot;               &quot;112815&quot;              </span>
<span class="co">## [157] &quot;112115&quot;               &quot;111415&quot;               &quot;110715&quot;              </span>
<span class="co">## [160] &quot;103115&quot;               &quot;102415&quot;               &quot;101715&quot;              </span>
<span class="co">## [163] &quot;101015&quot;               &quot;100315&quot;               &quot;092615&quot;              </span>
<span class="co">## [166] &quot;091915&quot;               &quot;091215&quot;               &quot;090515&quot;              </span>
<span class="co">## [169] &quot;082915&quot;               &quot;082215&quot;               &quot;081515&quot;              </span>
<span class="co">## [172] &quot;080815&quot;               &quot;080115&quot;               &quot;072515&quot;              </span>
<span class="co">## [175] &quot;071815&quot;               &quot;071115&quot;               &quot;070415&quot;              </span>
<span class="co">## [178] &quot;062715&quot;               &quot;062015&quot;               &quot;061315&quot;              </span>
<span class="co">## [181] &quot;060615&quot;               &quot;053015&quot;               &quot;052315&quot;              </span>
<span class="co">## [184] &quot;051615&quot;               &quot;050915&quot;               &quot;050215&quot;              </span>
<span class="co">## [187] &quot;042515&quot;               &quot;041815&quot;               &quot;041115&quot;              </span>
<span class="co">## [190] &quot;040415&quot;               &quot;032815&quot;               &quot;032115&quot;              </span>
<span class="co">## [193] &quot;031415&quot;               &quot;030715&quot;               &quot;022815&quot;              </span>
<span class="co">## [196] &quot;022115&quot;               &quot;021415&quot;               &quot;020715&quot;              </span>
<span class="co">## [199] &quot;013115&quot;               &quot;012415&quot;               &quot;011715&quot;              </span>
<span class="co">## [202] &quot;011015&quot;               &quot;010315&quot;               &quot;122714&quot;              </span>
<span class="co">## [205] &quot;122014&quot;               &quot;121314&quot;               &quot;120614&quot;              </span>
<span class="co">## [208] &quot;112914&quot;               &quot;112214&quot;               &quot;111514&quot;              </span>
<span class="co">## [211] &quot;110814&quot;               &quot;110114&quot;               &quot;102514&quot;              </span>
<span class="co">## [214] &quot;101814&quot;               &quot;101114&quot;               &quot;100414&quot;              </span>
<span class="co">## [217] &quot;092714&quot;               &quot;092014&quot;               &quot;091314&quot;              </span>
<span class="co">## [220] &quot;090614&quot;               &quot;083014&quot;               &quot;082314&quot;              </span>
<span class="co">## [223] &quot;081614&quot;               &quot;080914&quot;               &quot;080214&quot;              </span>
<span class="co">## [226] &quot;072614&quot;               &quot;071914&quot;               &quot;071214&quot;              </span>
<span class="co">## [229] &quot;070514&quot;               &quot;062814&quot;               &quot;062114&quot;              </span>
<span class="co">## [232] &quot;061414&quot;               &quot;060714&quot;               &quot;053114&quot;              </span>
<span class="co">## [235] &quot;052414&quot;               &quot;051714&quot;               &quot;051014&quot;              </span>
<span class="co">## [238] &quot;050314&quot;               &quot;042614&quot;               &quot;041914&quot;              </span>
<span class="co">## [241] &quot;041214&quot;               &quot;040514&quot;               &quot;032914&quot;              </span>
<span class="co">## [244] &quot;032214&quot;               &quot;031514&quot;               &quot;030814&quot;              </span>
<span class="co">## [247] &quot;030114&quot;               &quot;022214&quot;               &quot;021514&quot;              </span>
<span class="co">## [250] &quot;020814&quot;               &quot;020114&quot;               &quot;012514&quot;              </span>
<span class="co">## [253] &quot;011814&quot;               &quot;011114&quot;               &quot;010414&quot;              </span>
<span class="co">## [256] &quot;122813&quot;               &quot;122113&quot;               &quot;121413&quot;              </span>
<span class="co">## [259] &quot;120713&quot;               &quot;113013&quot;               &quot;112313&quot;              </span>
<span class="co">## [262] &quot;111613&quot;               &quot;110913&quot;               &quot;110213&quot;              </span>
<span class="co">## [265] &quot;102613&quot;               &quot;101913&quot;               &quot;101213&quot;              </span>
<span class="co">## [268] &quot;100513&quot;               &quot;092813&quot;               &quot;092113&quot;              </span>
<span class="co">## [271] &quot;091413&quot;               &quot;090713&quot;               &quot;083113&quot;              </span>
<span class="co">## [274] &quot;082413&quot;               &quot;081713&quot;               &quot;081013&quot;              </span>
<span class="co">## [277] &quot;080313&quot;               &quot;072713&quot;               &quot;072013&quot;              </span>
<span class="co">## [280] &quot;071313&quot;               &quot;070613&quot;               &quot;062913&quot;              </span>
<span class="co">## [283] &quot;062213&quot;               &quot;061513&quot;               &quot;060813&quot;              </span>
<span class="co">## [286] &quot;060113&quot;               &quot;052513&quot;               &quot;051813&quot;              </span>
<span class="co">## [289] &quot;051113&quot;               &quot;050413&quot;               &quot;042713&quot;              </span>
<span class="co">## [292] &quot;042013&quot;               &quot;041313&quot;               &quot;040613&quot;              </span>
<span class="co">## [295] &quot;033013&quot;               &quot;032313&quot;               &quot;031613&quot;              </span>
<span class="co">## [298] &quot;030913&quot;               &quot;030213&quot;               &quot;022313&quot;              </span>
<span class="co">## [301] &quot;021613&quot;               &quot;020913&quot;               &quot;020213&quot;              </span>
<span class="co">## [304] &quot;012613&quot;               &quot;011913&quot;               &quot;011213&quot;              </span>
<span class="co">## [307] &quot;010513&quot;               &quot;122912&quot;               &quot;122212&quot;              </span>
<span class="co">## [310] &quot;121512&quot;               &quot;120812&quot;               &quot;120112&quot;              </span>
<span class="co">## [313] &quot;112412&quot;               &quot;111712&quot;               &quot;111012&quot;              </span>
<span class="co">## [316] &quot;110312&quot;               &quot;102712&quot;               &quot;102012&quot;              </span>
<span class="co">## [319] &quot;101312&quot;               &quot;100612&quot;               &quot;092912&quot;              </span>
<span class="co">## [322] &quot;092212&quot;               &quot;091512&quot;               &quot;090812&quot;              </span>
<span class="co">## [325] &quot;090112&quot;               &quot;082512&quot;               &quot;081812&quot;              </span>
<span class="co">## [328] &quot;081112&quot;               &quot;080412&quot;               &quot;072812&quot;              </span>
<span class="co">## [331] &quot;072112&quot;               &quot;071412&quot;               &quot;070712&quot;              </span>
<span class="co">## [334] &quot;063012&quot;               &quot;062312&quot;               &quot;061612&quot;              </span>
<span class="co">## [337] &quot;060912&quot;               &quot;060212&quot;               &quot;052612&quot;              </span>
<span class="co">## [340] &quot;051912&quot;               &quot;051212&quot;               &quot;050512&quot;              </span>
<span class="co">## [343] &quot;042812&quot;               &quot;042112&quot;               &quot;041412&quot;              </span>
<span class="co">## [346] &quot;040712&quot;               &quot;033112&quot;               &quot;032412&quot;              </span>
<span class="co">## [349] &quot;031712&quot;               &quot;031012&quot;               &quot;030312&quot;              </span>
<span class="co">## [352] &quot;022512&quot;               &quot;021812&quot;               &quot;021112&quot;              </span>
<span class="co">## [355] &quot;020412&quot;               &quot;012812&quot;               &quot;012112&quot;              </span>
<span class="co">## [358] &quot;011412&quot;               &quot;010712&quot;               &quot;2011 Totals&quot;         </span>
<span class="co">## [361] &quot;123111&quot;               &quot;122411&quot;               &quot;121711&quot;              </span>
<span class="co">## [364] &quot;121011&quot;               &quot;120311&quot;               &quot;112611&quot;              </span>
<span class="co">## [367] &quot;111911&quot;               &quot;111211&quot;               &quot;110511&quot;              </span>
<span class="co">## [370] &quot;102911&quot;               &quot;102211&quot;               &quot;101511&quot;              </span>
<span class="co">## [373] &quot;100811&quot;               &quot;100111&quot;               &quot;092411&quot;              </span>
<span class="co">## [376] &quot;091711&quot;               &quot;091011&quot;               &quot;090311&quot;              </span>
<span class="co">## [379] &quot;082711&quot;               &quot;082011&quot;               &quot;081311&quot;              </span>
<span class="co">## [382] &quot;080611&quot;               &quot;073011&quot;               &quot;072311&quot;              </span>
<span class="co">## [385] &quot;071611&quot;               &quot;070911&quot;               &quot;070211&quot;              </span>
<span class="co">## [388] &quot;062511&quot;               &quot;061811&quot;               &quot;061111&quot;              </span>
<span class="co">## [391] &quot;060411&quot;               &quot;052811&quot;               &quot;052111&quot;              </span>
<span class="co">## [394] &quot;051411&quot;               &quot;050711&quot;               &quot;043011&quot;              </span>
<span class="co">## [397] &quot;042311&quot;               &quot;041611&quot;               &quot;040911&quot;              </span>
<span class="co">## [400] &quot;040211&quot;               &quot;032611&quot;               &quot;031911&quot;              </span>
<span class="co">## [403] &quot;031211&quot;               &quot;030511&quot;               &quot;022611&quot;              </span>
<span class="co">## [406] &quot;021911&quot;               &quot;021211&quot;               &quot;020511&quot;              </span>
<span class="co">## [409] &quot;012911&quot;               &quot;012211&quot;               &quot;011511&quot;              </span>
<span class="co">## [412] &quot;010811&quot;</span></code></pre>
<p>Many of these dates are in a <code>mmddyy</code> format, but some are inconsistently formatted. There is one sheet that has a 4-digit year (<code>2017</code> instead of <code>17</code>), and a few sheets that contain summaries. Let’s go ahead and drop the summary tables and fix the 4-digit year table.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># filter: drop &quot;2011 Totals&quot; and &quot;January 2011-to date&quot;</span>
<span class="co"># clean &quot;09092017&quot; to &quot;090917&quot;</span>
<span class="co"># convert clean date to a date format</span>
havv_df &lt;-<span class="st"> </span>havv_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>(sheet_name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2011 Totals&quot;</span>, <span class="st">&quot;January 2011-to date&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">clean_name =</span> <span class="kw">case_when</span>(sheet_name <span class="op">==</span><span class="st"> &quot;09092017&quot;</span> <span class="op">~</span><span class="st"> &quot;090917&quot;</span>, 
                                <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>sheet_name),
         <span class="dt">date =</span> lubridate<span class="op">::</span><span class="kw">mdy</span>(clean_name)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">print</span>()
<span class="co">## # A tibble: 410 x 4</span>
<span class="co">##    sheet_name data               clean_name date      </span>
<span class="co">##    &lt;chr&gt;      &lt;list&gt;             &lt;chr&gt;      &lt;date&gt;    </span>
<span class="co">##  1 111018     &lt;tibble [52 × 10]&gt; 111018     2018-11-10</span>
<span class="co">##  2 110318     &lt;tibble [52 × 10]&gt; 110318     2018-11-03</span>
<span class="co">##  3 102718     &lt;tibble [52 × 10]&gt; 102718     2018-10-27</span>
<span class="co">##  4 102018     &lt;tibble [52 × 10]&gt; 102018     2018-10-20</span>
<span class="co">##  5 101318     &lt;tibble [52 × 10]&gt; 101318     2018-10-13</span>
<span class="co">##  6 100618     &lt;tibble [52 × 10]&gt; 100618     2018-10-06</span>
<span class="co">##  7 092918     &lt;tibble [52 × 10]&gt; 092918     2018-09-29</span>
<span class="co">##  8 092218     &lt;tibble [52 × 10]&gt; 092218     2018-09-22</span>
<span class="co">##  9 091518     &lt;tibble [52 × 10]&gt; 091518     2018-09-15</span>
<span class="co">## 10 090818     &lt;tibble [52 × 10]&gt; 090818     2018-09-08</span>
<span class="co">## # … with 400 more rows</span></code></pre>
</div>
<div id="reshaping-the-data" class="section level2">
<h2>Reshaping the data</h2>
<p>At this point, we’re ready to unnest the data. A few things that happen along the way:</p>
<ul>
<li>we don’t need the <code>clean_name</code> variable, so we drop it.</li>
<li>There are some inconsistencies in the spelling and capitalization of state values, which get fixed along the way.</li>
<li>There are some “total” state rows, which we could re-create ourselves and thus don’t need to be in the raw data.</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># unnest into &quot;long&quot; data</span>
<span class="co"># we don&#39;t really need &quot;clean_name&quot; so drop it</span>
<span class="co"># convert characters back to numbers</span>
<span class="co"># states are sometimes titlecase, sometimes uppercase</span>
<span class="co"># states are sometimes &quot;total&quot; and we don&#39;t want that</span>
havv &lt;-<span class="st"> </span>havv_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>clean_name) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(total_transactions<span class="op">:</span>multi_match_mixed), as.numeric) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">state =</span> <span class="kw">toupper</span>(state),
         <span class="dt">state =</span> <span class="kw">case_when</span>(state <span class="op">==</span><span class="st"> &quot;NEBRASKS&quot;</span> <span class="op">~</span><span class="st"> &quot;NEBRASKA&quot;</span>,
                           <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>state)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>(state <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;TOTAL&quot;</span>, <span class="st">&quot;TOTALS&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">print</span>()
<span class="co">## # A tibble: 20,910 x 12</span>
<span class="co">##    sheet_name date       state total_transacti… unprocessed_tra…</span>
<span class="co">##    &lt;chr&gt;      &lt;date&gt;     &lt;chr&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span>
<span class="co">##  1 111018     2018-11-10 ALAB…             1069                0</span>
<span class="co">##  2 111018     2018-11-10 ALAS…               34                0</span>
<span class="co">##  3 111018     2018-11-10 ARIZ…              753                0</span>
<span class="co">##  4 111018     2018-11-10 ARKA…                0                0</span>
<span class="co">##  5 111018     2018-11-10 CALI…            47923                0</span>
<span class="co">##  6 111018     2018-11-10 COLO…                0                0</span>
<span class="co">##  7 111018     2018-11-10 CONN…             2797                0</span>
<span class="co">##  8 111018     2018-11-10 DELA…                0                0</span>
<span class="co">##  9 111018     2018-11-10 DIST…                0                0</span>
<span class="co">## 10 111018     2018-11-10 FLOR…              570                0</span>
<span class="co">## # … with 20,900 more rows, and 7 more variables: total_nonmatches &lt;dbl&gt;,</span>
<span class="co">## #   total_matches &lt;dbl&gt;, single_match_alive &lt;dbl&gt;,</span>
<span class="co">## #   single_match_deceased &lt;dbl&gt;, multi_match_alive &lt;dbl&gt;,</span>
<span class="co">## #   multi_match_deceased &lt;dbl&gt;, multi_match_mixed &lt;dbl&gt;</span></code></pre>
</div>
</div>
<div id="learn-about-the-data" class="section level1">
<h1>Learn about the data</h1>
<p>From here, we could ask questions such as, how many attempted matches (transactions) lead to nonmatches?</p>
<pre class="sourceCode r"><code class="sourceCode r">havv <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(date) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize_if</span>(is.numeric, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p_nonmatch =</span> total_nonmatches <span class="op">/</span><span class="st"> </span>(total_matches <span class="op">+</span><span class="st"> </span>total_nonmatches)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> p_nonmatch)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Percent Nonmatched&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Date&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),
                     <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span>
<span class="st">  </span>ggthemes<span class="op">::</span><span class="kw">theme_base</span>(<span class="dt">base_family =</span> <span class="st">&quot;Source Sans Pro&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.background =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.background =</span> 
          <span class="kw">element_rect</span>(<span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">size =</span> <span class="dv">1</span>),
        <span class="dt">axis.ticks =</span> <span class="kw">element_line</span>(<span class="dt">lineend =</span> <span class="st">&quot;square&quot;</span>), 
        <span class="dt">axis.ticks.length =</span> <span class="kw">unit</span>(<span class="fl">0.25</span>, <span class="st">&quot;lines&quot;</span>))</code></pre>
<p><img src="/posts/2018-11-29-hava-xl_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>Okay weird! We see a <em>lot</em> of attempted voter registrations fail to match. Does this mean these voters don’t get registered? I don’t know, but this is definitely something that deserves more scrutiny.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Not long ago, a state DMV worker mistyped my birth date when issuing me a Wisconsin driver’s license. This led to a misprint on my license, an inability to update my voter registration online when I moved addresses, and even led to the “new Michael” getting a fresh letter to register with the Selective Service System.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Michael DeCrescenzo </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=/2018/2018-11-29-hava-xl/>/2018/2018-11-29-hava-xl/</span>
            </p>
            
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="/tags/data/">
                    #data</a></span>
            
            <span class="tag"><a href="/tags/tidyverse/">
                    #tidyverse</a></span>
            
            <span class="tag"><a href="/tags/r/">
                    #R&#34;</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="/2018/2018-10-19-partialling-out/" class="prev" rel="prev" title="A Visualization of Partial Effects in Multiple Regression"><i class="iconfont icon-left"></i>&nbsp;A Visualization of Partial Effects in Multiple Regression</a>
         
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2016–2019</span>
        
         
            <span class="author" itemprop="copyrightHolder"><a href="/">Michael DeCrescenzo</a> | </span> 
         

         
    <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
